<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Complete Signup | Exun 2025</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/complete.css">
    <link rel="stylesheet" href="/css/toast.css">
</head>
<body data-page="complete">

        <main class="login-page">
            <div class="login-container">
                <div class="login-header">
                    <img src="/assets/exun.png" class="login-logo" />
                    <h1 class="login-title">Complete your signup</h1>
                    <p class="login-subtitle">Provide the remaining details to finish your account.</p>
                </div>

                <div class="complete-grid">
                    <div id="profile-section" class="profile-panel">
                        <form class="login-form" id="complete-profile-form">
                            <div class="profile-grid">
                                <div>
                                    <div class="form-group">
                                        <label class="form-label" for="fullname">Full name</label>
                                        <input class="form-input" id="fullname" name="fullname" type="text" aria-describedby="err_fullname" value="{{if .User}}{{.User.Fullname}}{{end}}" />
                                        <div class="form-error" id="err_fullname" aria-live="polite"></div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="phone_number">Phone number</label>
                                        <input class="form-input" id="phone_number" name="phone_number" type="tel" aria-describedby="err_phone_number" value="{{if .User}}{{.User.PhoneNumber}}{{end}}" />
                                        <div class="form-error" id="err_phone_number" aria-live="polite"></div>
                                    </div>
                                    <div class="form-group" id="principal-email-field">
                                        <label class="form-label" for="principals_email">Principal's email</label>
                                        <input class="form-input" id="principals_email" name="principals_email" type="email" aria-describedby="err_principals_email" value="{{if .User}}{{.User.PrincipalsEmail}}{{end}}" />
                                        <div class="form-error" id="err_principals_email" aria-live="polite"></div>
                                    </div>
                                </div>
                                <div>
                    <div class="form-group" id="institution-field">
                        <label class="form-label" for="institution_name">Institution name</label>
                        <input class="form-input" id="institution_name" name="institution_name" type="text" value="{{if .User}}{{.User.InstitutionName}}{{end}}" />
                    </div>

                                    <div class="form-group">
                                        <label class="form-label" for="address">Address</label>
                                        <input class="form-input" id="address" name="address" type="text" value="{{if .User}}{{.User.Address}}{{end}}" />
                                    </div>
                                    <div class="form-group" id="principal-name-field">
                                        <label class="form-label" for="principals_name">Principal's name</label>
                                        <input class="form-input" id="principals_name" name="principals_name" type="text" value="{{if .User}}{{.User.PrincipalsName}}{{end}}" />
                                    </div>
                                </div>
                            </div>
                    <div class="form-group">
                        <label class="form-label" for="individual">Individual</label>
                                            <input type="checkbox" id="individual" name="individual" {{if .User}}{{if .User.Individual}}checked{{end}}{{end}} />
                    </div>
                            <div class="form-group button-row">
                                <button class="login-btn" type="button" id="save-profile">Save profile</button>
                                <button class="login-btn" type="button" id="back-to-profile">Back to profile</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="message" style="margin-top:12px"></div>
            </div>
        </main>


    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script>
        async function saveProfile() {
            const individualCheckbox = document.getElementById('individual');
            ['fullname','phone_number','principals_email'].forEach(id => {
                const el = document.getElementById('err_' + id);
                if (el) el.textContent = '';
            });

            const payload = {
                fullname: document.getElementById('fullname')?.value || '',
                phone_number: document.getElementById('phone_number')?.value || '',
                principals_email: document.getElementById('principals_email')?.value || '',
                individual: individualCheckbox ? individualCheckbox.checked : false,
                institution_name: document.getElementById('institution_name')?.value || '',
                address: document.getElementById('address')?.value || '',
                principals_name: document.getElementById('principals_name')?.value || '',
            };

            if (payload.individual === true) {
                delete payload.principals_email;
            }

            let clientErr = false;
            if (!payload.fullname.trim()) {
                document.getElementById('err_fullname').textContent = 'Full name is required';
                clientErr = true;
            }
            if (!/^[0-9]{10}$/.test(payload.phone_number.trim())) {
                document.getElementById('err_phone_number').textContent = 'Enter a 10-digit phone number';
                clientErr = true;
            }
            const isInd = payload.individual === true;
            if (!isInd) {
                if (!payload.principals_email.trim()) {
                    document.getElementById('err_principals_email').textContent = "Principal's email is required for teams";
                    clientErr = true;
                } else if (!/^\S+@\S+\.\S+$/.test(payload.principals_email.trim())) {
                    document.getElementById('err_principals_email').textContent = 'Enter a valid email address';
                    clientErr = true;
                }
            }

            if (clientErr) {
                Utils.showToast('Fix the highlighted errors', 'error');
                return;
            }
            try {
                const resp = await ExunServices.api.apiRequest('/complete_api', { method: 'POST', body: JSON.stringify(payload) });
                if (resp.status === 'success') {
                    Utils.showToast('Profile saved. Redirecting to summary...', 'success');
                    setTimeout(() => window.location.href = '/summary', 700);
                } else {
                    Utils.showToast(resp.error || resp.message || 'Failed to save profile.', 'error');
                }
            } catch (err) {
                Utils.showToast(err.message || 'Failed to save profile.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const individualCheckbox = document.getElementById('individual');
            const instField = document.getElementById('institution-field');
            const princField = document.getElementById('principal-name-field');
            const princEmailField = document.getElementById('principal-email-field');

            function toggleFields() {
                const isInd = individualCheckbox ? individualCheckbox.checked : false;
                if (instField) instField.style.display = isInd ? 'none' : 'block';
                if (princField) princField.style.display = isInd ? 'none' : 'block';
                if (princEmailField) princEmailField.style.display = isInd ? 'none' : 'block';
                const principalsEmail = document.getElementById('principals_email');
                if (principalsEmail) principalsEmail.required = !isInd;
            }

            try {
                const resp = await ExunServices.api.apiRequest('/complete');
                if (resp && resp.status === 'success' && resp.data) {
                    const vals = resp.data.values || {};
                    if (vals.fullname) document.getElementById('fullname').value = vals.fullname;
                    if (vals.phone_number) document.getElementById('phone_number').value = vals.phone_number;
                    if (vals.principals_email) document.getElementById('principals_email').value = vals.principals_email;
                    if (typeof vals.individual === 'boolean') document.getElementById('individual').checked = vals.individual;
                    if (vals.institution_name) document.getElementById('institution_name').value = vals.institution_name;
                    if (vals.address) document.getElementById('address').value = vals.address;
                    if (vals.principals_name) document.getElementById('principals_name').value = vals.principals_name;
                }
            } catch (err) {
            }

            if (individualCheckbox) {
                individualCheckbox.addEventListener('change', toggleFields);
                toggleFields();
            }
            document.getElementById('save-profile').addEventListener('click', (e) => {
                e.preventDefault();
                saveProfile();
            });
            const backBtn = document.getElementById('back-to-profile');
            if (backBtn) {
                backBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = '/summary';
                });
            }
        });
    </script>
</body>
</html>