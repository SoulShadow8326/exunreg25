<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Complete Signup | Exun 2025</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/complete.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.min.css" />
    <link rel="stylesheet" href="/css/toast.css">
</head>
<body data-page="complete">

        <main class="login-page">
            <div class="login-container">
                <div class="login-header">
                    <img src="/assets/exun.png" class="login-logo" />
                    <h1 class="login-title">Complete your signup</h1>
                    <p class="login-subtitle">Provide the remaining details to finish your account.</p>
                </div>

                <div class="complete-grid">
                    <div id="profile-section" class="profile-panel">
                        <form class="login-form" id="complete-profile-form" autocomplete="off" spellcheck="false">
                            <div class="profile-grid">
                                <div class="form-group" id="institution-field">
                                    <label class="form-label" for="institution_name">Institution name</label>
                                    <input class="form-input" id="institution_name" name="institution_name" type="text" autocomplete="off" value="{{if .User}}{{.User.InstitutionName}}{{end}}" />
                                </div>

                                <div class="form-group" id="fullname-field" style="display: none;">
                                    <label class="form-label" for="fullname">Full name</label>
                                    <input class="form-input" id="fullname" name="fullname" type="text" autocomplete="off" value="{{if .User}}{{.User.Fullname}}{{end}}" />
                                    <div class="form-error" id="err_fullname" aria-live="polite"></div>
                                </div>

                                <div class="form-group phone-half phone-right" id="phone-field">
                                    <label class="form-label" for="phone_number">Phone number</label>
                                    <input class="form-input" id="phone_number" name="phone_number" type="tel" autocomplete="off" inputmode="numeric" pattern="[0-9]*" placeholder="" aria-describedby="err_phone_number" value="{{if .User}}{{.User.PhoneNumber}}{{end}}" />
                                    <div class="form-error" id="err_phone_number" aria-live="polite"></div>
                                </div>

                                <div class="form-group full-span" id="address-field">
                                    <label class="form-label" for="address">Address</label>
                                    <input class="form-input" id="address" name="address" type="text" autocomplete="off" value="{{if .User}}{{.User.Address}}{{end}}" />
                                </div>

                                <div class="form-group" id="principal-name-field">
                                    <label class="form-label" for="principals_name">Principal's name</label>
                                    <input class="form-input" id="principals_name" name="principals_name" type="text" autocomplete="off" value="{{if .User}}{{.User.PrincipalsName}}{{end}}" />
                                </div>

                                <div class="form-group" id="principal-email-field">
                                    <label class="form-label" for="principals_email">Principal's email</label>
                                    <input class="form-input" id="principals_email" name="principals_email" type="email" autocomplete="off" aria-describedby="err_principals_email" value="{{if .User}}{{.User.PrincipalsEmail}}{{end}}" />
                                    <div class="form-error" id="err_principals_email" aria-live="polite"></div>
                                </div>

                                

                            </div>
                    <div class="form-group">
                        <label class="checkbox-wrapper" id="individual-wrapper">
                            <span class="form-label">Individual</span>
                            <input type="checkbox" id="individual" name="individual" class="checkbox-input" {{if .User}}{{if .User.Individual}}checked{{end}}{{end}} />
                            <span class="checkbox-custom" aria-hidden="true"></span>
                        </label>
                    </div>
                            <div class="form-group button-row">
                                <button class="login-btn" type="button" id="save-profile">Save profile</button>
                                <button class="login-btn" type="button" id="back-to-profile">Back to profile</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="message" style="margin-top:12px"></div>
            </div>
        </main>


    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/libphonenumber-js@1.11.11/bundle/libphonenumber-js.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script>
        let iti = null;
        async function saveProfile() {
            const individualCheckbox = document.getElementById('individual');
            ['fullname','phone_number','principals_email'].forEach(id => {
                const el = document.getElementById('err_' + id);
                if (el) el.textContent = '';
            });

            const phoneEl = document.getElementById('phone_number');
            const phoneVal = (iti && phoneEl) ? iti.getNumber() : (phoneEl ? phoneEl.value : '');
            const phoneCountry = (iti && phoneEl) ? iti.getSelectedCountryData().iso2 : '';

            const payload = {
                fullname: document.getElementById('fullname')?.value || '',
                phone_number: phoneVal || '',
                phone_country: phoneCountry || '',
                principals_email: document.getElementById('principals_email')?.value || '',
                individual: individualCheckbox ? individualCheckbox.checked : false,
                institution_name: document.getElementById('institution_name')?.value || '',
                address: document.getElementById('address')?.value || '',
                principals_name: document.getElementById('principals_name')?.value || '',
            };

            if (payload.individual === true) {
                delete payload.principals_email;
            }

            let clientErr = false;
            const isInd = payload.individual === true;
            if (isInd) {
                if (!payload.fullname.trim()) {
                    document.getElementById('err_fullname').textContent = 'Full name is required';
                    clientErr = true;
                }
            }
            if (iti && phoneEl) {
                if (!iti.isValidNumber()) {
                    document.getElementById('err_phone_number').textContent = 'Enter a valid phone number with country code';
                    clientErr = true;
                }
            } else {
                if (!/^[0-9]{10}$/.test(payload.phone_number.trim())) {
                    document.getElementById('err_phone_number').textContent = 'Enter a 10-digit phone number';
                    clientErr = true;
                }
            }
            if (!isInd) {
                if (!payload.principals_email.trim()) {
                    document.getElementById('err_principals_email').textContent = "Principal's email is required for teams";
                    clientErr = true;
                } else if (!/^\S+@\S+\.\S+$/.test(payload.principals_email.trim())) {
                    document.getElementById('err_principals_email').textContent = 'Enter a valid email address';
                    clientErr = true;
                }
            }

            if (clientErr) {
                Utils.showToast('Fix the highlighted errors', 'error');
                return;
            }
            try {
                const resp = await ExunServices.api.apiRequest('/complete_api', { method: 'POST', body: JSON.stringify(payload) });
                if (resp.status === 'success') {
                    Utils.showToast('Profile saved. Redirecting to summary...', 'success');
                    setTimeout(() => window.location.href = '/summary', 700);
                } else {
                    Utils.showToast(resp.error || resp.message || 'Failed to save profile.', 'error');
                }
            } catch (err) {
                Utils.showToast(err.message || 'Failed to save profile.', 'error');
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const individualCheckbox = document.getElementById('individual');
            const instField = document.getElementById('institution-field');
            const princField = document.getElementById('principal-name-field');
            const princEmailField = document.getElementById('principal-email-field');
            const fullnameField = document.getElementById('fullname-field');
            const phoneEl = document.getElementById('phone_number');

            try {
                if (phoneEl && window.intlTelInput) {
                    iti = window.intlTelInput(phoneEl, {
                        separateDialCode: true,
                        preferredCountries: ['in','us','gb','ae','ca'],
                        autoPlaceholder: 'off',
                        utilsScript: 'https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js'
                    });
                    try { phoneEl.setAttribute('placeholder', ''); } catch (e) {}

                    function detectCountryFromNumber(val) {
                        if (!val) return null;
                        const parseFn = window.parsePhoneNumberFromString
                            || (window.libphonenumber && window.libphonenumber.parsePhoneNumberFromString)
                            || (window.libphonenumberjs && window.libphonenumberjs.parsePhoneNumberFromString);
                        if (typeof parseFn === 'function') {
                            try {
                                const pn = parseFn(val);
                                if (pn && pn.country) return pn.country.toLowerCase();
                            } catch (e) {
                            }
                        }
                        return null;
                    }

                    try {
                        const cur = phoneEl.value && phoneEl.value.trim();
                        if (cur) {
                            const detected = detectCountryFromNumber(cur);
                            if (detected) {
                                try { iti.setCountry(detected); } catch (e) {}
                                try { iti.setNumber(cur); } catch (e) {}
                            } else if (cur.startsWith('+')) {
                                try { iti.setNumber(cur); } catch (e) {}
                            }
                        }
                    } catch (e) {}
                }
            } catch (e) {
                console.warn('intl-tel-input not available', e);
            }

            try {
                if (phoneEl) {
                    phoneEl.addEventListener('input', (ev) => {
                        const start = phoneEl.selectionStart || 0;
                        const cleaned = phoneEl.value.replace(/(?!^\+)\D+/g, '');
                        if (phoneEl.value !== cleaned) {
                            phoneEl.value = cleaned;
                            try { phoneEl.setSelectionRange(Math.max(start - 1, 0), Math.max(start - 1, 0)); } catch (_) {}
                        }

                        if (iti && phoneEl.value && phoneEl.value.startsWith('+')) {
                            try { iti.setNumber(phoneEl.value); } catch (e) {}
                        }
                    });

                    phoneEl.addEventListener('paste', (ev) => {
                        try {
                            const clip = (ev.clipboardData || window.clipboardData).getData('text') || '';
                            ev.preventDefault();
                            const m = clip.trim().match(/^\+?\d+/);
                            const val = m ? m[0] : clip.replace(/\D+/g, '');
                            phoneEl.value = val;
                            phoneEl.dispatchEvent(new Event('input', { bubbles: true }));
                            if (iti && phoneEl.value && phoneEl.value.startsWith('+')) {
                                try { iti.setNumber(phoneEl.value); } catch (e) {}
                            }
                        } catch (e) {
                        }
                    });
                }
            } catch (e) {
            }

            function toggleFields() {
                const isInd = individualCheckbox ? individualCheckbox.checked : false;
                if (instField) instField.style.display = isInd ? 'none' : 'block';
                if (princField) princField.style.display = isInd ? 'none' : 'block';
                if (princEmailField) princEmailField.style.display = isInd ? 'none' : 'block';
                if (fullnameField) fullnameField.style.display = isInd ? 'block' : 'none';
                const principalsEmail = document.getElementById('principals_email');
                if (principalsEmail) principalsEmail.required = !isInd;
            }

            try {
                const resp = await ExunServices.api.apiRequest('/complete');
                if (resp && resp.status === 'success' && resp.data) {
                    const vals = resp.data.values || {};
                    if (vals.fullname) document.getElementById('fullname').value = vals.fullname;
                    if (vals.phone_number) document.getElementById('phone_number').value = vals.phone_number;
                    if (vals.principals_email) document.getElementById('principals_email').value = vals.principals_email;
                    if (typeof vals.individual === 'boolean') document.getElementById('individual').checked = vals.individual;
                    if (vals.institution_name) document.getElementById('institution_name').value = vals.institution_name;
                    if (vals.address) document.getElementById('address').value = vals.address;
                    if (vals.principals_name) document.getElementById('principals_name').value = vals.principals_name;
                }
            } catch (err) {
            }

            if (individualCheckbox) {
                individualCheckbox.addEventListener('change', toggleFields);
                toggleFields();
            }
            document.getElementById('save-profile').addEventListener('click', (e) => {
                e.preventDefault();
                saveProfile();
            });
            const backBtn = document.getElementById('back-to-profile');
            if (backBtn) {
                backBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.location.href = '/summary';
                });
            }
        });
    </script>
</body>
</html>