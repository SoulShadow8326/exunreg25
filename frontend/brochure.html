<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brochure | Exun 2025</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/brochure.css">
    <link rel="stylesheet" href="/css/toast.css">
</head>
<body data-page="brochure">
    {{template "navbar" .}}
    
    <main class="brochure-page">
        <div class="container">
            <div class="brochure-header">
                <h1 class="brochure-title">Exun 2025 Brochure</h1>
                <p class="brochure-subtitle">Comprehensive information about our events and symposium</p>
            </div>
            
            <div class="brochure-content">
                <div class="brochure-grid">
                    <aside class="brochure-nav">
                        <h4>Contents</h4>
                        <ul id="nav-list" class="brochure-nav__list">{{.BrochureNavHTML}}</ul>
                    </aside>
                    <section class="brochure-main">
                        <div id="html-content" class="brochure-markdown"></div>
                    </section>
                </div>
            </div>
        </div>
    </main>
    
    {{template "footer" .}}
    <script type="text/plain" id="raw-markdown-source" style="display:none">{{.BrochureMarkdown}}</script>
    <script id="brochure-toc-json" type="application/json">{{.BrochureTOC}}</script>
    <script id="brochure-scroll-to" type="text/plain" style="display:none">{{.BrochureScrollTo}}</script>

    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const rawMarkdownEl = document.getElementById('raw-markdown-source');
        const markdownText = rawMarkdownEl ? rawMarkdownEl.textContent || rawMarkdownEl.innerText : '';

        try {
            let md = String(markdownText || '');
            const tableRegex = /(^\|[^\n]*\n\|[ \-:\|]+\n(?:\|[^\n]*\n?)+)/gm;
            md = md.replace(tableRegex, (block) => {
                const lines = block.trim().split(/\r?\n/);
                if (lines.length < 3) return block;
                const headerLine = lines[0];
                const sepLine = lines[1];
                const dataLines = lines.slice(2);
                if (headerLine.replace(/[|\s]/g, '') === '') {
                    const firstData = dataLines.shift();
                    if (!firstData) return block;
                    const headerCells = firstData.replace(/^\||\|$/g, '').split('|').map(s => s.trim() || '');
                    const newHeader = '| ' + headerCells.join(' | ') + ' |';
                    const newBlock = [newHeader, sepLine].concat(dataLines).join('\n') + '\n';
                    return newBlock;
                }
                return block;
            });
            md = md.replace(/\*\*?\\?\*:\*\*?/g, '<strong>*:</strong>');
            md = md.replace(/\\([*_`~\[\]()#+\-.!|])/g, '$1');
            md = md.replace(/^\s*-\s*$(?:\r?\n)?/gm, '');

            if (marked && typeof marked.setOptions === 'function') {
                marked.setOptions({ gfm: true, tables: true });
            }
            const htmlContent = marked.parse ? marked.parse(md) : marked(md);
            const container = document.getElementById('html-content');
            if (container) container.innerHTML = htmlContent;

            try {
                const tocEl = document.getElementById('brochure-toc-json');
                const scrollEl = document.getElementById('brochure-scroll-to');
                const toc = tocEl && tocEl.textContent ? JSON.parse(tocEl.textContent) : [];
                const scrollTo = scrollEl && (scrollEl.textContent || scrollEl.innerText) ? (scrollEl.textContent || scrollEl.innerText).trim() : '';

                function slugify(s) {
                    return String(s || '')
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-+|-+$/g, '');
                }

                const headings = container.querySelectorAll('h1, h2, h3');
                headings.forEach(h => {
                    const id = slugify((h.textContent || '').trim());
                    if (id) h.id = id;
                });

                if (scrollTo) {
                    const target = document.getElementById(scrollTo);
                    if (target) {
                        setTimeout(() => target.scrollIntoView({ behavior: 'smooth', block: 'start' }), 50);
                    }
                }
            } catch (e) {
                console.warn('Brochure TOC/scroll handling failed', e);
            }

            try {
                const navList = document.getElementById('nav-list');
                function handleNavClick(evt) {
                    const a = evt.target.closest && evt.target.closest('a');
                    if (!a) return;
                    const href = a.getAttribute('href') || a.href || '';
                    let url;
                    try {
                        url = new URL(href, location.origin);
                    } catch (err) {
                        return;
                    }
                    if (url.pathname && url.pathname.startsWith('/brochure')) {
                        evt.preventDefault();
                        const slug = url.pathname.replace(/^\/brochure\/?/, '').replace(/\/$/, '');
                        history.pushState(null, '', '/brochure/' + slug);
                        const target = document.getElementById(slug);
                        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
                if (navList) navList.addEventListener('click', handleNavClick);

                window.addEventListener('popstate', () => {
                    const p = location.pathname || '';
                    if (p.startsWith('/brochure/')) {
                        const slug = p.replace(/^\/brochure\/?/, '').replace(/\/$/, '');
                        const target = document.getElementById(slug);
                        if (target) target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            } catch (e) {
                console.warn('Failed to attach brochure nav handlers', e);
            }
        } catch (e) {
            console.error('Failed to render brochure markdown', e);
        }
    </script>
    
</body>
</html>
