<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brochure | Exun 2025</title>
    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon">
    
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/navbar.css">
    <link rel="stylesheet" href="/css/footer.css">
    <link rel="stylesheet" href="/css/brochure.css">
    <link rel="stylesheet" href="/css/toast.css">
</head>
<body data-page="brochure">
    {{template "navbar" .}}
    
    <main class="brochure-page">
        <div class="container">
            <div class="brochure-header">
                <h1 class="brochure-title">Exun 2025 Brochure</h1>
                <p class="brochure-subtitle">Comprehensive information about our events and symposium</p>
            </div>
            
            <div class="brochure-content">
                <div class="brochure-grid">
                    <aside class="brochure-nav">
                        <h4>Contents</h4>
                        <ul id="nav-list" class="brochure-nav__list"></ul>
                    </aside>
                    <section class="brochure-main">
                        <div id="html-content" class="brochure-markdown"></div>
                    </section>
                </div>
            </div>
        </div>
    </main>
    
    {{template "footer" .}}
    <script type="text/plain" id="raw-markdown-source" style="display:none">{{.BrochureMarkdown}}</script>

    <script src="/js/api.js"></script>
    <script src="/js/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const rawMarkdownEl = document.getElementById('raw-markdown-source');
        const markdownText = rawMarkdownEl ? rawMarkdownEl.textContent || rawMarkdownEl.innerText : '';

        try {
            let md = String(markdownText || '');
            const tableRegex = /(^\|[^\n]*\n\|[ \-:\|]+\n(?:\|[^\n]*\n?)+)/gm;
            md = md.replace(tableRegex, (block) => {
                const lines = block.trim().split(/\r?\n/);
                if (lines.length < 3) return block;
                const headerLine = lines[0];
                const sepLine = lines[1];
                const dataLines = lines.slice(2);
                if (headerLine.replace(/[|\s]/g, '') === '') {
                    const firstData = dataLines.shift();
                    if (!firstData) return block;
                    const headerCells = firstData.replace(/^\||\|$/g, '').split('|').map(s => s.trim() || '');
                    const newHeader = '| ' + headerCells.join(' | ') + ' |';
                    const newBlock = [newHeader, sepLine].concat(dataLines).join('\n') + '\n';
                    return newBlock;
                }
                return block;
            });
            md = md.replace(/\*\*?\\?\*:\*\*?/g, '<strong>*:</strong>');
            md = md.replace(/\\([*_`~\[\]()#+\-.!|])/g, '$1');
            md = md.replace(/^\s*-\s*$(?:\r?\n)?/gm, '');

            if (marked && typeof marked.setOptions === 'function') {
                marked.setOptions({ gfm: true, tables: true });
            }
            const htmlContent = marked.parse ? marked.parse(md) : marked(md);
            const container = document.getElementById('html-content');
            if (container) container.innerHTML = htmlContent;

            const slugify = (s) => {
                if (!s) return '';
                return String(s).toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            };

            ['h1','h2','h3','h4'].forEach(tag => {
                const els = Array.from(container.querySelectorAll(tag));
                els.forEach(h => {
                    if (!h.id || h.id.trim() === '') {
                        const id = slugify(h.textContent || h.innerText || '');
                        if (id) h.id = id;
                    }
                });
            });

            const navList = document.getElementById('nav-list');
            if (navList) {
                const lines = md.split(/\r?\n/);
                const stripMarkdown = (s) => {
                    if (!s) return '';
                    try {
                        const doc = new DOMParser().parseFromString(s, 'text/html');
                        s = doc.documentElement.textContent || s;
                    } catch (e) {}
                    let out = String(s).replace(/\*\*(.*?)\*\*/g, '$1');
                    out = out.replace(/\*(.*?)\*/g, '$1');
                    out = out.replace(/`(.*?)`/g, '$1');
                    out = out.replace(/!\[([^\]]*)\]\([^\)]*\)/g, '$1');
                    out = out.replace(/\[([^\]]+)\]\([^\)]*\)/g, '$1');
                    out = out.replace(/[\*_>]/g, '');
                    return out.trim();
                };

                lines.forEach(line => {
                    const m = line.match(/^(#{1,3})\s+(.*)$/);
                    if (m) {
                        const level = m[1].length;
                        const rawTitle = m[2].trim();
                        const title = stripMarkdown(rawTitle);
                        if (!title) return;
                        const id = slugify(title);
                        const li = document.createElement('li');
                        li.className = 'nav-level-' + level;
                        const a = document.createElement('a');
                        a.href = '#' + id;
                        a.textContent = title;
                        li.appendChild(a);
                        navList.appendChild(li);
                        const target = document.getElementById(id);
                        if (target) {
                            target.style.color = '#456484';
                        }
                    }
                });
            }
        } catch (e) {
            console.error('Failed to render brochure markdown', e);
        }
    </script>
    <script type="text/plain" id="raw-markdown-source" style="display:none">{{.BrochureMarkdown}}</script>
</body>
</html>
